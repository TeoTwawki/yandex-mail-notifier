import {
    CONNECTION_NAME,
    UPDATE_STATE,
    DISPATCH
} from './constants';

let listeners = [];
let state;

function handleUpdatedState(msg) {
    if (msg.type === UPDATE_STATE) {
        state = msg.data;

        listeners.forEach(l => l());
    }
}

function subscribe(listener) {
    listeners.push(listener);

    // return unsubscribe function
    return function () {
        listeners = listeners.filter(l => l !== listener);
    };
}

function dispatch(data) {
    // send message to "background" store
    chrome.runtime.sendMessage({
        type: DISPATCH,
        ...data
    });
}

function getState() {
    return state;
}

export default function () {
    // notify "background" about new store
    const connection = chrome.runtime.connect({name: CONNECTION_NAME});

    // listen for changes in the "background" store
    // update internal state and notify every listener
    connection.onMessage.addListener(handleUpdatedState);

    return new Promise(resolve => {
        chrome.runtime.sendMessage({type: UPDATE_STATE}, null, res => {
            state = res;

            resolve({
                subscribe,
                dispatch,
                getState
            });
        });
    });
}
